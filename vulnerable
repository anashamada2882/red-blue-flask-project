from flask import Flask, request, render_template_string
import sqlite3
import hashlib
import os

app = Flask(__name__)
UPLOAD_FOLDER = 'uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Create database with MD5 passwords (VULNERABLE!)
def init_db():
    conn = sqlite3.connect('users.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users (username TEXT, password TEXT)''')
    md5_pass = hashlib.md5('password123'.encode()).hexdigest()
    c.execute("DELETE FROM users WHERE username='admin'")
    c.execute("INSERT INTO users VALUES ('admin', ?)", (md5_pass,))
    conn.commit()
    conn.close()

init_db()

# VULNERABILITY #1: SQL Injection in login
@app.route('/', methods=['GET', 'POST'])
def login():
    message = ''
    if request.method == 'POST':
        username = request.form['username']
        password = hashlib.md5(request.form['password'].encode()).hexdigest()
        
        conn = sqlite3.connect('users.db')
        c = conn.cursor()
        # DANGEROUS: No prepared statements!
        query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
        c.execute(query)
        user = c.fetchone()
        conn.close()
        
        if user:
            message = f'‚úÖ Login successful! Welcome {username}'
        else:
            message = '‚ùå Login failed.'
    
    return render_template_string('''
    <!DOCTYPE html>
    <html>
    <head>
        <title>Vulnerable Login System</title>
        <style>
            body { font-family: Arial; max-width: 600px; margin: 50px auto; padding: 20px; }
            input { margin: 10px 0; padding: 8px; width: 100%; }
            button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
            .message { padding: 10px; margin: 10px 0; background: #f0f0f0; }
        </style>
    </head>
    <body>
        <h1>üîì Vulnerable Login System</h1>
        <p><strong>Test credentials:</strong> admin / password123</p>
        
        <form method="post">
            <label>Username:</label>
            <input type="text" name="username" required>
            <label>Password:</label>
            <input type="password" name="password" required>
            <button type="submit">Login</button>
        </form>
        
        {% if message %}
        <div class="message">{{ message }}</div>
        {% endif %}
        
        <hr>
        
        <h2>üì§ File Upload</h2>
        <form method="post" enctype="multipart/form-data" action="/upload">
            <input type="file" name="file" required>
            <button type="submit">Upload File</button>
        </form>
    </body>
    </html>
    ''', message=message)

# VULNERABILITY #2: Unsafe file upload (allows PHP shells!)
@app.route('/upload', methods=['POST'])
def upload():
    file = request.files['file']
    if file:
        filename = file.filename
        filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        file.save(filepath)
        return f'‚úÖ File uploaded successfully!<br>Access at: <a href="/uploads/{filename}">/uploads/{filename}</a><br><a href="/">Back to login</a>'
    return '‚ùå No file selected!'

# Serve uploaded files
@app.route('/uploads/<filename>')
def uploaded_file(filename):
    return f'File: {filename} exists in uploads folder'

if __name__ == '__main__':
    print("üöÄ Starting VULNERABLE Flask app...")
    print("üìç Access at: http://127.0.0.1:5000")
    print("‚ö†Ô∏è  WARNING: This app has intentional vulnerabilities for educational purposes!")
    app.run(host='0.0.0.0', port=5001, debug=True)


